# 模板删除逻辑修改说明

## 修改时间
2025-10-30

## 修改内容

将模板删除从**软删除**改为**物理删除**（真实删除）。

## 修改前后对比

### 修改前：软删除

```python
def destroy(self, request, *args, **kwargs):
    """删除模板（软删除）并删除相关文件"""
    template = self.get_object()
    
    # 删除文件
    # ...
    
    # ❌ 软删除：只标记为已删除
    template.is_deleted = True
    template.save()
    
    return DetailResponse(msg="模板删除成功，相关文件已清理")
```

**特点：**
- 数据库记录保留
- 设置 `is_deleted=True` 标记
- 文件被删除
- 可以通过数据库恢复

### 修改后：物理删除

```python
def destroy(self, request, *args, **kwargs):
    """删除模板 - 直接删除记录并删除物理文件"""
    template = self.get_object()
    
    # 删除文件
    # ...
    
    # ✅ 物理删除：真实删除数据库记录
    template.delete(soft_delete=False)
    
    return DetailResponse(msg="模板删除成功")
```

**特点：**
- 数据库记录被删除
- 物理文件被删除
- **无法恢复**
- 彻底清理

## 详细实现

### 完整代码

```python
def destroy(self, request, *args, **kwargs):
    """删除模板 - 直接删除记录并删除物理文件"""
    try:
        template = self.get_object()
        
        # 获取模板文件的完整物理路径
        template_file_path = template.full_file_path
        
        # 1️⃣ 删除模板文件（占位符模板文件）
        if template_file_path and os.path.exists(template_file_path):
            try:
                os.remove(template_file_path)
                logger.info(f"已删除模板文件: {template_file_path}")
            except Exception as e:
                logger.error(f"删除模板文件失败: {template_file_path}, 错误: {str(e)}")
        
        # 2️⃣ 删除原始模板文件（如果存在）
        # 从占位符文件路径推断原始文件路径
        if template_file_path:
            placeholder_path = template_file_path
            if 'case_templates_placeholders' in placeholder_path:
                # 将占位符路径转换为原始路径
                original_path = placeholder_path.replace('case_templates_placeholders', 'case_templates')
                # 移除_placeholder后缀
                if '_placeholder' in original_path:
                    original_path = original_path.replace('_placeholder', '')
                
                if os.path.exists(original_path):
                    try:
                        os.remove(original_path)
                        logger.info(f"已删除原始模板文件: {original_path}")
                    except Exception as e:
                        logger.warning(f"删除原始模板文件失败: {original_path}, 错误: {str(e)}")
        
        # 3️⃣ 直接删除数据库记录（不是软删除）
        template.delete(soft_delete=False)
        
        logger.info(f"模板删除成功: id={template.id}, name={template.template_name}")
        return DetailResponse(msg="模板删除成功")
        
    except Exception as e:
        logger.error(f"删除模板失败: {str(e)}")
        return ErrorResponse(msg=f"删除模板失败: {str(e)}")
```

## 删除流程

```
删除模板流程:

1. 获取模板对象
   template = self.get_object()
   ↓
2. 获取模板文件路径
   template_file_path = template.full_file_path
   ↓
3. 删除占位符模板文件
   if exists(template_file_path):
       os.remove(template_file_path)
   ↓
4. 删除原始模板文件（如果存在）
   if 'case_templates_placeholders' in path:
       original_path = convert_to_original_path(path)
       os.remove(original_path)
   ↓
5. 直接删除数据库记录
   template.delete(soft_delete=False)  # ✅ 物理删除
   ↓
6. 返回成功响应
   return DetailResponse(msg="模板删除成功")
```

## API 接口

### 接口地址

```
DELETE /api/case/document-templates/{id}/
```

### 请求示例

```bash
# 删除 ID 为 5 的模板
curl -X DELETE http://localhost:8000/api/case/document-templates/5/
```

### 成功响应

```json
{
  "code": 2000,
  "msg": "模板删除成功"
}
```

### 错误响应

```json
{
  "code": 5000,
  "msg": "删除模板失败: [错误信息]"
}
```

## 删除的文件

### 1. 占位符模板文件

**路径示例：**
```
media/case_templates_placeholders/起诉状_placeholder_1698123456.docx
```

**特点：**
- 包含占位符的模板文件
- 存储在 `case_templates_placeholders` 目录
- 文件名包含 `_placeholder` 后缀

### 2. 原始模板文件

**路径示例：**
```
media/case_templates/起诉状_1698123456.docx
```

**特点：**
- 上传时的原始文件
- 存储在 `case_templates` 目录
- 无 `_placeholder` 后缀

### 路径转换逻辑

```python
# 占位符路径
placeholder_path = "media/case_templates_placeholders/起诉状_placeholder_1698123456.docx"

# 转换为原始路径
original_path = placeholder_path.replace('case_templates_placeholders', 'case_templates')
# => "media/case_templates/起诉状_placeholder_1698123456.docx"

original_path = original_path.replace('_placeholder', '')
# => "media/case_templates/起诉状_1698123456.docx"
```

## 日志记录

### 成功删除

```
INFO: 已删除模板文件: /path/to/media/case_templates_placeholders/起诉状_placeholder.docx
INFO: 已删除原始模板文件: /path/to/media/case_templates/起诉状.docx
INFO: 模板删除成功: id=5, name=起诉状
```

### 文件删除失败

```
ERROR: 删除模板文件失败: /path/to/template.docx, 错误: 文件被占用
WARNING: 删除原始模板文件失败: /path/to/original.docx, 错误: 文件不存在
INFO: 模板删除成功: id=5, name=起诉状
```

**注意：** 即使文件删除失败，数据库记录仍会被删除。

## 与文档删除的一致性

现在模板删除和文档删除的逻辑保持一致：

### CaseDocumentViewSet.destroy()

```python
def destroy(self, request, *args, **kwargs):
    """删除文档 - 直接删除记录并删除物理文件"""
    document = self.get_object()
    
    # 删除物理文件
    if file_path and os.path.exists(file_path):
        os.remove(file_path)
    
    # ✅ 直接删除数据库记录
    document.delete(soft_delete=False)
    
    return DetailResponse(msg="文档删除成功")
```

### DocumentTemplateViewSet.destroy()

```python
def destroy(self, request, *args, **kwargs):
    """删除模板 - 直接删除记录并删除物理文件"""
    template = self.get_object()
    
    # 删除物理文件（包括占位符文件和原始文件）
    if template_file_path and os.path.exists(template_file_path):
        os.remove(template_file_path)
    if original_path and os.path.exists(original_path):
        os.remove(original_path)
    
    # ✅ 直接删除数据库记录
    template.delete(soft_delete=False)
    
    return DetailResponse(msg="模板删除成功")
```

**共同特点：**
- 都是物理删除（`soft_delete=False`）
- 都删除物理文件
- 都返回统一的响应格式

## 注意事项

### ⚠️ 重要警告

1. **无法恢复**
   - 物理删除后，数据库记录和文件都被永久删除
   - 无法通过系统恢复
   - 只能通过数据库备份恢复

2. **级联删除**
   - 如果有其他数据关联到该模板（如外键），可能会导致级联删除
   - 建议删除前检查是否有文档使用该模板

3. **文件删除失败**
   - 如果文件被占用或权限不足，文件可能删除失败
   - 但数据库记录仍会被删除
   - 需要手动清理残留文件

### ✅ 最佳实践

1. **删除前确认**
   ```javascript
   // 前端应该提示用户确认
   if (confirm('确定要删除此模板吗？删除后无法恢复！')) {
       await deleteTemplate(templateId);
   }
   ```

2. **检查关联数据**
   ```python
   # 删除前检查是否有文档使用该模板
   document_count = CaseDocument.objects.filter(
       template_id=template.id,
       is_deleted=False
   ).count()
   
   if document_count > 0:
       return ErrorResponse(msg=f"该模板被 {document_count} 个文档使用，无法删除")
   ```

3. **定期清理孤立文件**
   ```bash
   # 定期检查并清理没有对应数据库记录的文件
   python manage.py cleanup_orphan_files
   ```

## 前端调用示例

### JavaScript (Axios)

```javascript
import axios from 'axios';

// 删除模板
async function deleteTemplate(templateId) {
  // 确认对话框
  const confirmed = confirm('确定要删除此模板吗？\n删除后无法恢复，模板文件也将被删除！');
  
  if (!confirmed) {
    return false;
  }
  
  try {
    const response = await axios.delete(
      `/api/case/document-templates/${templateId}/`
    );
    
    if (response.data.code === 2000) {
      alert('模板删除成功');
      // 刷新模板列表
      await loadTemplateList();
      return true;
    } else {
      alert(`删除失败: ${response.data.msg}`);
      return false;
    }
  } catch (error) {
    console.error('删除模板失败:', error);
    alert('删除模板失败，请重试');
    return false;
  }
}

// 使用示例
deleteTemplate(5);
```

### Vue 组件示例

```vue
<template>
  <div>
    <button @click="handleDelete(template.id)" class="btn-danger">
      删除模板
    </button>
  </div>
</template>

<script>
export default {
  methods: {
    async handleDelete(templateId) {
      const confirmed = await this.$confirm(
        '删除后无法恢复，确定要删除此模板吗？',
        '警告',
        {
          confirmButtonText: '确定删除',
          cancelButtonText: '取消',
          type: 'warning'
        }
      ).catch(() => false);
      
      if (!confirmed) return;
      
      try {
        const response = await this.$axios.delete(
          `/api/case/document-templates/${templateId}/`
        );
        
        if (response.data.code === 2000) {
          this.$message.success('模板删除成功');
          this.loadTemplateList(); // 刷新列表
        } else {
          this.$message.error(response.data.msg);
        }
      } catch (error) {
        this.$message.error('删除失败，请重试');
        console.error(error);
      }
    }
  }
}
</script>
```

## 数据库影响

### 删除前

```sql
SELECT id, template_name, is_deleted FROM document_template WHERE id = 5;
-- 结果：id=5, template_name='起诉状', is_deleted=0
```

### 删除后

```sql
SELECT id, template_name, is_deleted FROM document_template WHERE id = 5;
-- 结果：（无记录）
```

### 与软删除对比

**软删除后：**
```sql
SELECT id, template_name, is_deleted FROM document_template WHERE id = 5;
-- 结果：id=5, template_name='起诉状', is_deleted=1
```

**物理删除后：**
```sql
SELECT id, template_name, is_deleted FROM document_template WHERE id = 5;
-- 结果：（无记录）
```

## 相关文件

- **视图**: `case_management/views.py` - `DocumentTemplateViewSet.destroy()`
- **模型**: `case_management/models.py` - `DocumentTemplate`

## 总结

### 修改要点

✅ **已修改：**
- [x] 从软删除改为物理删除
- [x] 删除模板文件（占位符文件）
- [x] 删除原始模板文件
- [x] 使用 `logger` 记录日志（替代 `print`）
- [x] 统一错误处理和响应格式

### 删除内容

当删除一个模板时，会删除以下内容：

1. ✅ 数据库记录（`document_template` 表）
2. ✅ 占位符模板文件（`case_templates_placeholders/` 目录）
3. ✅ 原始模板文件（`case_templates/` 目录）

### 与文档删除保持一致

现在模板删除和文档删除都是物理删除，逻辑一致：
- `CaseDocumentViewSet.destroy()` - 物理删除
- `DocumentTemplateViewSet.destroy()` - 物理删除

