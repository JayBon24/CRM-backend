# 小程序 Tab1 和 Tab5 接口完善计划与测试预期

## 一、当前已完成的功能

### Tab1「客户」模块（7个接口）
- ✅ `GET /api/crm/client/list` - 获取客户列表（基本功能完成）
- ✅ `GET /api/crm/client/{id}` - 获取客户详情（基本功能完成）
- ✅ `POST /api/crm/client` - 创建客户/线索（基本功能完成）
- ✅ `PUT /api/crm/client/{id}` - 更新客户信息（基本功能完成）
- ✅ `POST /api/crm/client/{id}/apply` - 申领公海客户（基本功能完成）
- ✅ `POST /api/crm/client/{id}/assign` - 分配客户（基本功能完成）
- ✅ `POST /api/crm/client/approve/{apply_id}` - 审批客户申领（基本功能完成）

### Tab5「我的」模块（8个接口）
- ✅ `GET /api/mine/profile` - 获取个人资料（基本功能完成）
- ✅ `POST /api/mine/profile/update` - 更新个人资料（基本功能完成）
- ✅ `POST /api/mine/feedback` - 提交反馈（接口存在，但未实现数据持久化）
- ✅ `GET /api/mine/feedback/list` - 获取反馈列表（接口存在，但返回空数据）
- ✅ `GET /api/mine/approval/list` - 获取审批任务列表（基本功能完成）
- ✅ `POST /api/mine/approval/{id}/approve` - 审批任务（基本功能完成，仅支持 LEAD_CLAIM）
- ✅ `GET /api/mine/settings/remind` - 获取提醒偏好设置（接口存在，但未实现数据持久化）
- ✅ `POST /api/mine/settings/remind` - 设置提醒偏好（接口存在，但未实现数据持久化）

---

## 二、需要完善的地方

### 2.1 数据模型缺失

#### 2.1.1 Feedback（反馈）模型
**位置**: `customer_management/models/feedback.py`（需要创建）

**字段需求**:
```python
- id: 主键
- type: 反馈类型（bug/suggestion/ai_tag_feedback）
- content: 反馈内容
- images: 图片列表（JSON）
- contact: 联系方式
- context: 上下文信息（JSON，包含 client_id、field 等）
- status: 状态（open/processing/resolved）
- created_by: 创建人（外键 Users）
- created_at: 创建时间
```

**影响接口**:
- `POST /api/mine/feedback` - 需要保存到数据库
- `GET /api/mine/feedback/list` - 需要从数据库查询

**优先级**: 中

---

#### 2.1.2 UserSettings（用户设置）模型
**位置**: `customer_management/models/user_settings.py`（需要创建）或 `dvadmin/system/models/user_settings.py`

**字段需求**:
```python
- id: 主键
- user: 用户（外键 Users，一对一）
- default_remind_advance_minutes: 默认提醒提前时间（15/30）
- created_at: 创建时间
- updated_at: 更新时间
```

**影响接口**:
- `GET /api/mine/settings/remind` - 需要从数据库查询
- `POST /api/mine/settings/remind` - 需要保存到数据库

**优先级**: 中

---

### 2.2 客户信息字段缺失

#### 2.2.1 AI 标记相关字段
**位置**: `customer_management/views/miniapp/client_views.py`

**需要完善的字段**:
- `grade_source`: 客户等级来源（ai/manual）- 目前硬编码为 'ai'
- `preservation_status`: 保全状态 - 目前为 None
- `court`: 法院信息 - 目前为 None
- `lawyer`: 律师信息 - 目前为 None
- `ai_tags`: AI 标记完整信息 - 目前为空字典

**解决方案**:
1. 检查 Customer 模型是否有相关字段
2. 如果没有，需要在 Customer 模型中添加字段或创建关联表
3. 如果有，需要从模型正确读取

**优先级**: 低（不影响核心功能）

---

#### 2.2.2 组织信息字段
**位置**: `customer_management/views/miniapp/client_views.py`

**需要完善的字段**:
- `team_name`: 团队名称 - 目前为 None
- `branch_name`: 分所名称 - 目前为 None

**解决方案**:
1. 从 `user.dept` 获取部门信息
2. 从 `user.dept.parent` 获取上级部门（分所）信息
3. 或从 Customer 模型的 `team_id` 和 `branch_id` 关联查询部门表

**优先级**: 中（影响用户体验）

---

#### 2.2.3 字段映射确认
**位置**: `customer_management/views/miniapp/client_views.py`

**需要确认**:
- `demand_summary`: 目前映射到 `client.remark`，需要确认是否正确

**优先级**: 低

---

### 2.3 审批功能扩展

#### 2.3.1 审批类型支持
**位置**: `customer_management/views/miniapp/mine_views.py` 的 `approve_task` 函数

**当前状态**: 
- ✅ `LEAD_CLAIM`（线索申领）审批 - 已完全实现并测试通过
- ⚠️ `LEAD_CREATE`: 销售新增自有线索审核 - payload 已支持，但审批逻辑未实现
- ⚠️ `CLIENT_TRANSFER`（或 `HANDOVER`）: 客户转交审批 - payload 已支持，但审批逻辑未实现

**需要支持**:
- `LEAD_CREATE`: 销售新增自有线索审核（需要完善审批通过后的处理逻辑）
- `CLIENT_TRANSFER`（或 `HANDOVER`）: 客户转交审批（需要完善审批通过后的处理逻辑）

**优先级**: 中（影响完整审批流程）

---

### 2.4 数据范围过滤优化

#### 2.4.1 分所/团队数据范围
**位置**: `customer_management/views/miniapp/client_views.py` 的 `get_client_list` 函数

**当前逻辑**:
- BRANCH 角色：通过 `user.dept_id` 过滤 `branch_id`
- TEAM 角色：通过 `user.dept_id` 过滤 `team_id`

**状态**: ✅ 已实现并测试通过
- ✅ SALES 角色：只看到自己的客户（测试通过）
- ✅ TEAM 角色：看到本团队的客户（测试通过）
- ✅ BRANCH 角色：看到本分所的客户（测试通过）
- ✅ HQ 角色：看到全所的客户（测试通过）

**需要确认**:
- ⚠️ `user.dept_id` 是否正确对应 `Customer.branch_id` 和 `Customer.team_id`（当前测试通过，但需要业务确认）
- ⚠️ 是否需要考虑部门层级关系（当前实现已满足测试要求）

**优先级**: 高（影响数据准确性）✅ 已实现并测试通过

---

### 2.5 回收风险计算

#### 2.5.1 回收风险等级和截止时间
**位置**: Customer 模型

**当前状态**: 字段存在，但可能未自动计算

**需要确认**:
- 回收风险等级（`recycle_risk_level`）是否自动计算
- 回收截止时间（`recycle_deadline`）是否自动计算
- 计算规则是否符合文档要求：
  - 领取线索后 1 个月内未形成有效拜访
  - 客户进入跟进状态后 6 个月内未交案
  - 客户赢单后 6 个月内无新合同

**优先级**: 中（影响业务逻辑）

---

## 三、测试预期效果

### 3.1 Tab1「客户」模块测试

#### 3.1.1 获取客户列表
**测试用例**:
```
GET /api/crm/client/list?page=1&pageSize=20
Headers: Authorization: Bearer <token>
```

**预期结果**:
- ✅ 返回状态码 2000
- ✅ 返回分页数据：`{ rows: [...], total: 100, page: 1, pageSize: 20 }`
- ✅ 每个客户包含完整字段（id、status、sales_stage、client_name 等）
- ✅ 根据用户角色过滤数据范围：
  - SALES: 只看到自己的客户
  - TEAM: 看到本团队的客户
  - BRANCH: 看到本分所的客户
  - HQ: 看到全所的客户
- ✅ 支持筛选参数：status、sales_stage、keyword、grade 等
- ✅ 支持排序：order_by、order_direction

**当前问题**:
- ⚠️ `team_name` 和 `branch_name` 为 None（不影响功能，但影响显示）- 已添加 `team_id` 和 `branch_id` 字段
- ⚠️ `preservation_status`、`court`、`lawyer` 为 None（如果模型没有这些字段，属于正常）

---

#### 3.1.2 获取客户详情
**测试用例**:
```
GET /api/crm/client/1
Headers: Authorization: Bearer <token>
```

**预期结果**:
- ✅ 返回状态码 2000
- ✅ 返回客户完整信息
- ✅ 包含 `ai_tags` 字段（即使为空字典）
- ✅ 权限检查：SALES 只能查看自己的客户

**当前问题**:
- ⚠️ `ai_tags` 为空字典（如果模型没有相关字段，属于正常）

---

#### 3.1.3 创建客户
**测试用例**:
```
POST /api/crm/client
Headers: Authorization: Bearer <token>
Body: {
  "client_name": "测试客户",
  "contact_name": "张三",
  "mobile": "13800138000",
  "region": "北京市/朝阳区",
  "grade": "A"
}
```

**预期结果**:
- ✅ 返回状态码 2000
- ✅ 创建成功，返回客户 ID
- ✅ 客户状态为 `PUBLIC_POOL`
- ✅ 展业状态自动计算为 `PUBLIC_POOL`

---

#### 3.1.4 申领公海客户
**测试用例**:
```
POST /api/crm/client/1/apply
Headers: Authorization: Bearer <token>
Body: {
  "reason": "我有相关经验"
}
```

**预期结果**:
- ✅ 返回状态码 2000
- ✅ 创建审批任务
- ✅ 返回 `apply_id` 和 `status: 'pending'`
- ✅ 权限检查：HQ 和 BRANCH 角色不能申领（返回 4003）

---

#### 3.1.5 分配客户
**测试用例**:
```
POST /api/crm/client/1/assign
Headers: Authorization: Bearer <token>
Body: {
  "owner_user_id": 20,
  "user_name": "销售员B",
  "target_user_role_level": "SALES"
}
```

**预期结果**:
- ✅ 返回状态码 2000
- ✅ 客户分配成功
- ✅ 客户状态从 `PUBLIC_POOL` 转为 `FOLLOW_UP`
- ✅ 权限检查：只有管理角色可以分配
- ✅ 校验：不能分配给 HQ 和 BRANCH 角色（返回 4005）

---

#### 3.1.6 审批客户申领
**测试用例**:
```
POST /api/crm/client/approve/apply_123
Headers: Authorization: Bearer <token>
Body: {
  "approved": true,
  "reject_reason": ""
}
```

**预期结果**:
- ✅ 返回状态码 2000
- ✅ 审批成功
- ✅ 如果所有审批都通过，客户状态更新为 `FOLLOW_UP`
- ✅ 权限检查：只有管理角色可以审批
- ✅ 审批链流转正确（TEAM → BRANCH → HQ）

---

### 3.2 Tab5「我的」模块测试

#### 3.2.1 获取个人资料
**测试用例**:
```
GET /api/mine/profile
Headers: Authorization: Bearer <token>
```

**预期结果**:
- ✅ 返回状态码 2000
- ✅ 返回用户完整信息
- ✅ 包含 `roleLevel` 和 `orgScope`
- ✅ 包含 `teamName` 和 `branchName`（如果用户有部门）

**当前问题**:
- ⚠️ `teamName` 和 `branchName` 可能为 None（如果用户没有关联部门）

---

#### 3.2.2 提交反馈
**测试用例**:
```
POST /api/mine/feedback
Headers: Authorization: Bearer <token>
Body: {
  "type": "bug",
  "content": "客户列表页面加载缓慢",
  "images": ["https://example.com/image1.jpg"],
  "contact": "13800138000",
  "context": {
    "client_id": "1",
    "field": "grade"
  }
}
```

**预期结果**:
- ✅ 返回状态码 2000
- ✅ 返回反馈 ID
- ⚠️ **当前问题**: 数据未保存到数据库（需要创建 Feedback 模型）

---

#### 3.2.3 获取反馈列表
**测试用例**:
```
GET /api/mine/feedback/list?page=1&pageSize=20
Headers: Authorization: Bearer <token>
```

**预期结果**:
- ✅ 返回状态码 2000
- ✅ 返回分页数据
- ⚠️ **当前问题**: 返回空列表（需要创建 Feedback 模型并实现查询）

---

#### 3.2.4 获取审批任务列表
**测试用例**:
```
GET /api/mine/approval/list?status=pending
Headers: Authorization: Bearer <token>
```

**预期结果**:
- ✅ 返回状态码 2000
- ✅ 返回审批任务列表
- ✅ `status=pending` 时，只返回"当前应由我这个层级审批"的任务
- ✅ `status=handled` 时，返回"我本层级已处理过"的任务
- ✅ 权限检查：只有管理角色可以查看（SALES 返回 4003）

---

#### 3.2.5 审批任务
**测试用例**:
```
POST /api/mine/approval/approval_123/approve
Headers: Authorization: Bearer <token>
Body: {
  "approved": true,
  "reject_reason": ""
}
```

**预期结果**:
- ✅ 返回状态码 2000
- ✅ 审批成功
- ✅ 审批链流转正确
- ✅ 如果所有审批都通过，执行相应操作（如申领成功）
- ✅ **当前状态**: `LEAD_CLAIM` 类型已完全实现并测试通过
- ⚠️ **待完善**: `LEAD_CREATE` 和 `CLIENT_TRANSFER` 类型的审批逻辑需要完善

---

#### 3.2.6 获取提醒偏好设置
**测试用例**:
```
GET /api/mine/settings/remind
Headers: Authorization: Bearer <token>
```

**预期结果**:
- ✅ 返回状态码 2000
- ✅ 返回提醒偏好设置
- ⚠️ **当前问题**: 返回默认值 30（需要创建 UserSettings 模型并实现查询）

---

#### 3.2.7 设置提醒偏好
**测试用例**:
```
POST /api/mine/settings/remind
Headers: Authorization: Bearer <token>
Body: {
  "default_remind_advance_minutes": 15
}
```

**预期结果**:
- ✅ 返回状态码 2000
- ✅ 设置成功
- ✅ 验证：只能设置为 15 或 30（其他值返回 4001）
- ⚠️ **当前问题**: 数据未保存到数据库（需要创建 UserSettings 模型并实现保存）

---

## 四、完善优先级

### 高优先级（影响核心功能）
1. ✅ **数据范围过滤优化** - 确保不同角色看到正确的数据 ✅ 已完成并测试通过
2. ⚠️ **审批功能扩展** - 支持所有审批类型 ⚠️ 部分完成（仅支持 LEAD_CLAIM，LEAD_CREATE 和 CLIENT_TRANSFER 需要完善）

### 中优先级（影响用户体验）
3. ⚠️ **Feedback 模型** - 实现反馈功能的持久化 ⚠️ 未完成（接口已实现，但数据未持久化）
4. ⚠️ **UserSettings 模型** - 实现提醒偏好设置的持久化 ⚠️ 未完成（接口已实现，但数据未持久化）
5. ⚠️ **组织信息字段** - 显示团队名称和分所名称 ⚠️ 未完成（team_name 和 branch_name 为 None）

### 低优先级（不影响核心功能）
6. ⚠️ **AI 标记相关字段** - 如果业务需要，可以后续完善
7. ⚠️ **回收风险计算** - 如果业务需要，可以后续完善

---

## 五、测试检查清单

### 5.1 功能测试
- [x] 客户列表查询（不同角色、不同筛选条件）✅ 已测试通过
- [x] 客户详情查询（权限检查）✅ 已测试通过
- [x] 客户创建 ✅ 已测试通过
- [x] 客户更新 ✅ 已测试通过
- [x] 客户申领（权限检查）✅ 已测试通过
- [x] 客户分配（权限检查、角色校验）✅ 已测试通过
- [x] 审批流程（多级审批链）✅ 已测试通过
- [x] 个人资料查询和更新 ✅ 已测试通过
- [x] 反馈提交和查询 ⚠️ 接口已实现，但未持久化（测试通过）
- [x] 审批任务查询和审批 ✅ 已测试通过
- [x] 提醒偏好设置 ⚠️ 接口已实现，但未持久化（测试通过）

### 5.2 权限测试
- [x] SALES 角色：只能查看和操作自己的客户 ✅ 已测试通过
- [x] TEAM 角色：可以查看团队内客户，可以申领 ✅ 已测试通过
- [x] BRANCH 角色：可以查看本分所客户，不能申领 ✅ 已测试通过
- [x] HQ 角色：可以查看全所客户，不能申领 ✅ 已测试通过
- [x] 管理角色：可以分配客户，可以审批 ✅ 已测试通过
- [x] 销售角色：不能审批 ✅ 已测试通过

### 5.3 数据范围测试
- [x] SALES 角色：只看到自己的客户 ✅ 已测试通过
- [x] TEAM 角色：看到本团队的客户 ✅ 已测试通过
- [x] BRANCH 角色：看到本分所的客户 ✅ 已测试通过
- [x] HQ 角色：看到全所的客户 ✅ 已测试通过

### 5.4 错误处理测试
- [x] 未授权访问（401）✅ 已测试通过
- [x] 权限不足（4003）✅ 已测试通过
- [x] 资源不存在（4004）✅ 已测试通过（通过权限检查测试）
- [x] 参数错误（4001）✅ 已测试通过（通过提醒偏好无效值测试）
- [x] 业务逻辑错误（4005）✅ 已测试通过（通过申领非公海客户、分配给HQ角色等测试）

---

## 六、后续完善建议

1. **创建 Feedback 模型** - 实现反馈功能的完整支持
2. **创建 UserSettings 模型** - 实现用户设置的持久化
3. **完善 AI 标记功能** - 如果业务需要，添加相关字段和逻辑
4. **完善审批类型** - 支持 LEAD_CREATE 和 CLIENT_TRANSFER
5. **优化组织信息查询** - 正确显示团队名称和分所名称
6. ✅ **添加单元测试** - 确保代码质量 ✅ 已完成（35个测试全部通过）
7. **添加接口文档** - 使用 Swagger 或类似工具生成 API 文档

---

---

## 七、测试结果总结

### 7.1 测试执行情况
- **测试执行时间**: 2025-01-15
- **总测试数**: 35
- **通过**: 35 ✅
- **失败**: 0
- **成功率**: 100% 🎉

### 7.2 已完成的功能（测试通过）

#### Tab1「客户」模块（20个测试全部通过）
- ✅ 客户列表查询（支持筛选、排序、数据范围过滤）
- ✅ 客户详情查询（权限检查）
- ✅ 客户创建
- ✅ 客户更新（权限检查）
- ✅ 客户申领（权限检查、状态验证）
- ✅ 客户分配（权限检查、角色校验）
- ✅ 审批客户申领（多级审批链）

#### Tab5「我的」模块（14个测试全部通过）
- ✅ 个人资料查询和更新
- ✅ 反馈提交和查询（接口已实现，但数据未持久化）
- ✅ 审批任务查询和审批（支持 LEAD_CLAIM）
- ✅ 提醒偏好设置（接口已实现，但数据未持久化）

#### 审批流程测试（1个测试通过）
- ✅ 审批链流转测试（TEAM → BRANCH → HQ）

### 7.3 待完善的功能

#### 数据模型（中优先级）
- ⚠️ **Feedback 模型** - 接口已实现，但数据未持久化
- ⚠️ **UserSettings 模型** - 接口已实现，但数据未持久化

#### 功能扩展（中优先级）
- ⚠️ **审批类型扩展** - 仅支持 LEAD_CLAIM，LEAD_CREATE 和 CLIENT_TRANSFER 需要完善
- ⚠️ **组织信息字段** - team_name 和 branch_name 为 None（已添加 team_id 和 branch_id）

#### 低优先级
- ⚠️ **AI 标记相关字段** - grade_source、preservation_status、court、lawyer 等
- ⚠️ **回收风险计算** - 需要确认是否自动计算

---

**文档版本**: v1.1  
**最后更新**: 2025-01-15  
**测试状态**: ✅ 35/35 测试通过（100%）
