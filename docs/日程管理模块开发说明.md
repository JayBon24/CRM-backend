# 日程管理模块开发说明

## 模块概述

日程管理模块已集成到 `customer_management` 应用中，提供完整的日程CRUD功能和与客户管理的联动。

## 已完成的工作

### 1. 模块结构

```
customer_management/
├── models/
│   ├── customer.py          # 客户模型
│   └── schedule.py          # 日程和提醒模型
├── serializers/
│   ├── customer.py          # 客户序列化器
│   └── schedule.py          # 日程序列化器
├── views/
│   └── api/
│       ├── customer_views.py    # 客户ViewSet
│       └── schedule_views.py    # 日程ViewSet
└── urls/
    └── api_router.py        # API路由配置
```

### 2. 数据库模型

#### Schedule（日程表）
- **表名**: `schedule`
- **主要字段**:
  - 基本信息：title, description, schedule_type
  - 时间信息：start_time, end_time, is_all_day
  - 地点和参与人：location, participants
  - 状态和优先级：status, priority
  - 提醒设置：reminder_enabled, reminder_time, reminder_method
  - 关联信息：related_type, related_id
  - 重复规则：recurrence_rule
  - 附件：attachments
- **索引**:
  - (start_time, status)
  - (related_type, related_id)
  - (creator, start_time)
  - (schedule_type, status)

#### ScheduleReminder（日程提醒记录表）
- **表名**: `schedule_reminder`
- **主要字段**:
  - schedule: 关联的日程
  - remind_time: 提醒时间
  - remind_method: 提醒方式
  - is_sent: 是否已发送
  - sent_time: 发送时间
  - send_result: 发送结果
- **索引**:
  - (schedule, is_sent)
  - (remind_time, is_sent)

### 3. API接口

所有接口已按照 `docs/日程管理API接口文档.md` 的规范实现：

#### 基础CRUD
- `GET /api/schedule/schedules/` - 获取日程列表
- `GET /api/schedule/schedules/{id}/` - 获取日程详情
- `POST /api/schedule/schedules/` - 创建日程
- `PUT/PATCH /api/schedule/schedules/{id}/` - 更新日程
- `DELETE /api/schedule/schedules/{id}/` - 删除日程

#### 扩展功能
- `POST /api/schedule/schedules/batch_delete/` - 批量删除
- `POST /api/schedule/schedules/{id}/update_status/` - 更新状态
- `GET /api/schedule/schedules/today/` - 今日日程
- `GET /api/schedule/schedules/this_week/` - 本周日程
- `GET /api/schedule/schedules/statistics/` - 日程统计
- `GET /api/schedule/schedules/by_related/` - 获取关联对象的日程
- `GET /api/schedule/schedules/upcoming_reminders/` - 即将到来的提醒
- `GET /api/schedule/schedules/calendar_view/` - 日历视图数据
- `POST /api/schedule/schedules/create_from_customer_plan/` - 从客户计划创建日程

### 4. 序列化器

- `ScheduleSerializer` - 基础序列化器
- `ScheduleListSerializer` - 列表序列化器（简化版）
- `ScheduleDetailSerializer` - 详情序列化器（包含关联信息）
- `ScheduleCreateSerializer` - 创建序列化器（带验证）
- `ScheduleUpdateSerializer` - 更新序列化器（带验证）
- `ScheduleReminderSerializer` - 提醒记录序列化器
- `CreateFromCustomerPlanSerializer` - 从客户计划创建的序列化器
- `BatchDeleteSerializer` - 批量删除序列化器
- `UpdateStatusSerializer` - 更新状态序列化器

### 5. 项目配置

已完成以下配置更新：

#### customer_management/models/__init__.py
```python
from .customer import Customer
from .schedule import Schedule, ScheduleReminder
```

#### customer_management/urls/api_router.py
```python
router.register(r"customers", CustomerViewSet, basename="customers")
router.register(r"schedules", ScheduleViewSet, basename="schedules")
```

#### application/urls.py
```python
# 前端API（包含日程管理）
path("api/customer/", include("customer_management.urls.api_router")),
```

### 6. 数据库迁移

- ✅ 迁移文件已生成并应用
- ✅ 数据库表已创建：`schedule` 和 `schedule_reminder`
- ✅ 模块已集成到 `customer_management` 应用中

## 功能特性

### 1. 日程类型
- meeting（会议）
- court（开庭）
- deadline（截止日期）
- reminder（提醒）
- other（其他）

### 2. 状态管理
- pending（待处理）
- in_progress（进行中）
- completed（已完成）
- cancelled（已取消）

### 3. 优先级
- low（低）
- medium（中）
- high（高）
- urgent（紧急）

### 4. 提醒方式
- system（系统通知）
- email（邮件）
- sms（短信）
- wechat（微信）

### 5. 关联功能
- 可关联案件（case）
- 可关联客户（customer）
- 可关联客户计划（customer_plan）

### 6. 高级功能
- 全天事件支持
- 重复规则（支持按日/周/月/年重复）
- 附件管理
- 参与人员管理
- 提醒记录追踪

## 下一步工作

### 1. 前端集成
- 实现日程列表页面
- 实现日程创建/编辑表单
- 实现日历视图
- 实现提醒通知

### 2. 客户管理联动
- 在客户管理模块中添加"创建计划"功能
- 计划创建时自动同步到日程
- 在客户详情页显示相关日程

### 3. 提醒系统
- 实现定时任务扫描即将到来的提醒
- 实现系统通知推送
- 实现邮件提醒（可选）
- 实现短信提醒（可选）

### 4. 权限控制
- 添加日程的权限控制
- 实现日程的共享功能
- 实现团队日程

### 5. 数据初始化（可选）
- 创建初始化命令：`python manage.py init_customer`
- 添加示例数据
- 添加菜单权限配置

## 测试建议

### 1. 基础功能测试
```bash
# 启动开发服务器
python manage.py runserver

# 访问Swagger文档
http://localhost:8000/
```

### 2. API测试示例

#### 创建日程
```bash
POST /api/customer/schedules/
{
  "title": "与客户A洽谈合同",
  "description": "讨论合同细节",
  "schedule_type": "meeting",
  "start_time": "2025-12-27T14:00:00+08:00",
  "end_time": "2025-12-27T16:00:00+08:00",
  "location": "公司会议室A",
  "status": "pending",
  "priority": "high",
  "reminder_enabled": true,
  "reminder_time": 30
}
```

#### 获取今日日程
```bash
GET /api/customer/schedules/today/
```

#### 获取日程统计
```bash
GET /api/customer/schedules/statistics/
```

## 注意事项

1. **时区处理**：所有时间字段使用 `DateTimeField`，Django 会自动处理时区转换
2. **软删除**：日程使用软删除机制，删除的数据不会真正从数据库中移除
3. **关联验证**：创建日程时如果指定了关联类型和ID，需要确保关联对象存在
4. **提醒时间**：提醒时间是相对于日程开始时间的提前分钟数
5. **JSON字段**：participants、recurrence_rule、attachments 使用 JSON 格式存储

## 相关文档

- [日程管理API接口文档](./日程管理API接口文档.md)
- [项目结构与开发指南](./项目结构与开发指南.md)

## 更新日志

- 2025-12-26: 初始版本创建，完成基础功能开发
- 2025-12-26: 模块迁移到 `customer_management`，统一客户和日程管理
