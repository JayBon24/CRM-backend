# æ–‡æ¡£æ·»åŠ æ’åºå­—æ®µè¯´æ˜

## ä¿®æ”¹æ—¶é—´
2025-10-30

## åŠŸèƒ½æ¦‚è¿°

ä¸º `CaseDocument`ï¼ˆæ¡ˆä»¶æ–‡æ¡£ï¼‰æ·»åŠ  `sort_order` å­—æ®µï¼Œç”¨äºæ§åˆ¶æ–‡æ¡£åœ¨æ–‡æ¡£æ ‘ä¸­çš„æ˜¾ç¤ºé¡ºåºã€‚ç”Ÿæˆæ–‡ä¹¦æ—¶è‡ªåŠ¨ä»æ¨¡æ¿çš„ `sort_order` å¤åˆ¶åˆ°æ–‡æ¡£ï¼Œç¡®ä¿æ–‡æ¡£æŒ‰ç…§æ¨¡æ¿å®šä¹‰çš„é¡ºåºæ˜¾ç¤ºã€‚

## ä¿®æ”¹å†…å®¹

### 1. æ•°æ®åº“æ¨¡å‹

åœ¨ `CaseDocument` æ¨¡å‹ä¸­æ·»åŠ  `sort_order` å­—æ®µï¼š

```python
class CaseDocument(CoreModel, SoftDeleteModel):
    # ... å…¶ä»–å­—æ®µ
    
    sort_order = models.IntegerField(
        default=0,
        verbose_name="æ’åºåºå·",
        help_text="æ’åºåºå·ï¼Œæ•°å€¼è¶Šå°è¶Šé å‰ï¼ˆä»æ¨¡æ¿ç»§æ‰¿ï¼‰",
        db_index=True  # æ·»åŠ ç´¢å¼•æé«˜æŸ¥è¯¢æ€§èƒ½
    )
```

**å­—æ®µè¯´æ˜ï¼š**
- **é»˜è®¤å€¼**ï¼š0
- **ç”¨é€”**ï¼šæ§åˆ¶æ–‡æ¡£åœ¨åˆ—è¡¨ä¸­çš„æ˜¾ç¤ºé¡ºåº
- **æ¥æº**ï¼šä» `DocumentTemplate.sort_order` å¤åˆ¶è€Œæ¥
- **ç´¢å¼•**ï¼šå·²æ·»åŠ æ•°æ®åº“ç´¢å¼•

### 2. æ–‡æ¡£æ ‘æ’åº

ä¿®æ”¹ `get_case_document_tree()` å‡½æ•°ï¼š

#### æŸ¥è¯¢æ’åº

```python
# è·å–æ‰€æœ‰æ–‡æ¡£ï¼ˆæŒ‰ sort_order å‡åºæ’åˆ—ï¼‰
documents = CaseDocument.objects.filter(
    case_id=case_id,
    is_deleted=False
).select_related('template').order_by('sort_order', 'id')
```

**æ’åºè§„åˆ™ï¼š**
1. é¦–å…ˆæŒ‰ `sort_order` å‡åºï¼ˆæ•°å€¼è¶Šå°è¶Šé å‰ï¼‰
2. ç›¸åŒ `sort_order` æ—¶æŒ‰ `id` å‡åº

#### è¿”å›æ•°æ®

åœ¨æ–‡æ¡£èŠ‚ç‚¹ä¸­æ·»åŠ  `sort_order` å­—æ®µï¼š

```python
doc_node = {
    'id': f"doc_{doc.id}",
    'label': f"{doc.document_name}{doc.file_ext or ''}",
    # ... å…¶ä»–å­—æ®µ
    'print_count': doc.print_count,
    'sort_order': doc.sort_order,  # âœ… æ–°å¢ï¼šæ’åºåºå·
    'created_at': doc.create_datetime.strftime('%Y-%m-%d %H:%M:%S')
}
```

### 3. æ–‡ä¹¦ç”Ÿæˆé€»è¾‘

ä¿®æ”¹ `placeholder_template_service.py` ä¸­çš„æ–‡ä¹¦ç”Ÿæˆé€»è¾‘ï¼š

#### è·å–æ¨¡æ¿æ’åºå€¼

```python
def fill_and_save_by_record(self, case_id, template_record, data, request=None):
    # è·å–æ¨¡æ¿çš„æ’åºåºå·
    template_sort_order = getattr(template_record, 'sort_order', 0)
    
    # ä¼ é€’ç»™ä¿å­˜æ–¹æ³•
    # ...
```

#### ä¿å­˜æ—¶è®°å½•æ’åºå€¼

**`save_docx_document()` æ–¹æ³•ï¼š**

```python
def save_docx_document(
    self, 
    case_id, 
    document_name, 
    file_path, 
    template_sort_order=0,  # âœ… æ–°å¢å‚æ•°
    ...
):
    doc = CaseDocument.objects.create(
        case_id=case_id,
        document_name=document_name,
        sort_order=template_sort_order,  # âœ… è®°å½•æ¨¡æ¿çš„æ’åºåºå·
        # ... å…¶ä»–å­—æ®µ
    )
```

**`save_text_document()` æ–¹æ³•ï¼š**

```python
def save_text_document(
    self, 
    case_id, 
    document_name, 
    content, 
    template_sort_order=0,  # âœ… æ–°å¢å‚æ•°
    ...
):
    doc = CaseDocument.objects.create(
        case_id=case_id,
        document_name=document_name,
        sort_order=template_sort_order,  # âœ… è®°å½•æ¨¡æ¿çš„æ’åºåºå·
        # ... å…¶ä»–å­—æ®µ
    )
```

### 4. æ•°æ®åº“è¿ç§»

åˆ›å»ºè¿ç§»æ–‡ä»¶ï¼š`case_management/migrations/0015_add_case_document_sort_order.py`

```python
operations = [
    migrations.AddField(
        model_name='casedocument',
        name='sort_order',
        field=models.IntegerField(
            default=0, 
            verbose_name='æ’åºåºå·', 
            db_index=True
        ),
    ),
]
```

## æ•°æ®æµç¨‹

```
æ–‡ä¹¦ç”Ÿæˆæµç¨‹:

1. ç”¨æˆ·é€‰æ‹©æ¨¡æ¿ç”Ÿæˆæ–‡ä¹¦
   â†“
2. è¯»å–æ¨¡æ¿ä¿¡æ¯
   DocumentTemplate(id=1, template_name='èµ·è¯‰çŠ¶', sort_order=1000)
   â†“
3. è·å–æ¨¡æ¿çš„ sort_order
   template_sort_order = template_record.sort_order  # 1000
   â†“
4. æ¸²æŸ“æ–‡æ¡£å†…å®¹
   â†“
5. åˆ›å»ºæ–‡æ¡£è®°å½•
   CaseDocument.objects.create(
       template_id=1,
       document_name='èµ·è¯‰çŠ¶',
       sort_order=1000,  # âœ… ä»æ¨¡æ¿å¤åˆ¶
       ...
   )
   â†“
6. æŸ¥è¯¢æ–‡æ¡£æ ‘æ—¶æŒ‰ sort_order æ’åº
   documents.order_by('sort_order', 'id')
```

## API æ¥å£

### æ–‡æ¡£æ ‘æ¥å£

**æ¥å£åœ°å€ï¼š**
```
GET /api/case/cases/{id}/document_tree/
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 2000,
  "msg": "success",
  "data": [
    {
      "id": 1,
      "label": "æ¡ˆä»¶æ–‡ä¹¦",
      "path": "/case_documents",
      "type": "folder",
      "children": [
        {
          "id": "doc_123",
          "label": "èµ·è¯‰çŠ¶.docx",
          "document_id": 123,
          "sort_order": 1000,
          "print_count": 3,
          "created_at": "2025-10-30 10:00:00"
        },
        {
          "id": "doc_124",
          "label": "ç­”è¾©çŠ¶.docx",
          "document_id": 124,
          "sort_order": 2000,
          "print_count": 2,
          "created_at": "2025-10-30 11:00:00"
        },
        {
          "id": "doc_125",
          "label": "è¯æ®æ¸…å•.pdf",
          "document_id": 125,
          "sort_order": 3000,
          "print_count": 5,
          "created_at": "2025-10-30 12:00:00"
        }
      ]
    }
  ]
}
```

**æ’åºæ•ˆæœï¼š**
- æ–‡æ¡£æŒ‰ `sort_order` å‡åºæ˜¾ç¤º
- æ•°å€¼è¶Šå°çš„è¶Šé å‰æ˜¾ç¤º
- ç›¸åŒ `sort_order` æ—¶æŒ‰åˆ›å»ºé¡ºåºï¼ˆidï¼‰æ˜¾ç¤º

## ä½¿ç”¨åœºæ™¯

### 1. æŒ‰é‡è¦æ€§æ’åº

ç®¡ç†å‘˜å¯ä»¥é€šè¿‡è®¾ç½®æ¨¡æ¿çš„ `sort_order` æ¥æ§åˆ¶æ–‡ä¹¦çš„æ˜¾ç¤ºé¡ºåºï¼š

```python
# æ¨¡æ¿é…ç½®
templates = [
    {'name': 'èµ·è¯‰çŠ¶', 'sort_order': 1000},     # æœ€é‡è¦ï¼Œæ’æœ€å‰
    {'name': 'ç­”è¾©çŠ¶', 'sort_order': 2000},
    {'name': 'è¯æ®æ¸…å•', 'sort_order': 3000},
    {'name': 'é€è¾¾å›è¯', 'sort_order': 4000},
]

# ç”Ÿæˆçš„æ–‡æ¡£ä¼šè‡ªåŠ¨ç»§æ‰¿è¿™ä¸ªé¡ºåº
```

### 2. æ–‡æ¡£åˆ—è¡¨å±•ç¤º

```vue
<template>
  <el-tree :data="documentTree">
    <template #default="{ data }">
      <span v-if="data.type === 'file'">
        <!-- sort_order å°çš„åœ¨å‰é¢ -->
        <el-tag size="small">{{ data.sort_order }}</el-tag>
        {{ data.label }}
      </span>
    </template>
  </el-tree>
</template>

<script setup>
const response = await axios.get('/api/case/cases/50/document_tree/');
// æ–‡æ¡£å·²æŒ‰ sort_order æ’åº
const documentTree = ref(response.data.data);
</script>
```

### 3. è°ƒæ•´æ–‡æ¡£é¡ºåº

å¦‚æœéœ€è¦è°ƒæ•´å·²ç”Ÿæˆæ–‡æ¡£çš„é¡ºåºï¼Œå¯ä»¥æ›´æ–° `sort_order`ï¼š

```python
# è°ƒæ•´æ–‡æ¡£é¡ºåº
doc = CaseDocument.objects.get(id=123)
doc.sort_order = 500  # æ”¹åˆ°æ›´é å‰çš„ä½ç½®
doc.save()
```

### 4. æ‰¹é‡é‡æ’åº

```python
# æ‰¹é‡è°ƒæ•´æ–‡æ¡£é¡ºåº
documents = CaseDocument.objects.filter(case_id=50).order_by('sort_order')

for index, doc in enumerate(documents):
    doc.sort_order = (index + 1) * 1000
    
CaseDocument.objects.bulk_update(documents, ['sort_order'])
```

## ä¸æ¨¡æ¿æ’åºçš„å…³ç³»

### æ¨¡æ¿æ’åº

`DocumentTemplate.sort_order` æ§åˆ¶æ¨¡æ¿åœ¨æ¨¡æ¿åˆ—è¡¨ä¸­çš„æ˜¾ç¤ºé¡ºåºï¼š

```python
# æ¨¡æ¿åˆ—è¡¨æŒ‰ sort_order æ’åº
templates = DocumentTemplate.objects.filter(
    is_deleted=False
).order_by('sort_order', 'id')
```

### æ–‡æ¡£æ’åº

`CaseDocument.sort_order` æ§åˆ¶æ–‡æ¡£åœ¨æ–‡æ¡£æ ‘ä¸­çš„æ˜¾ç¤ºé¡ºåºï¼š

```python
# æ–‡æ¡£åˆ—è¡¨æŒ‰ sort_order æ’åº
documents = CaseDocument.objects.filter(
    case_id=50,
    is_deleted=False
).order_by('sort_order', 'id')
```

### ç»§æ‰¿å…³ç³»

```
DocumentTemplate.sort_order (æ¨¡æ¿)
         â†“ (ç”Ÿæˆæ–‡ä¹¦æ—¶å¤åˆ¶)
CaseDocument.sort_order (æ–‡æ¡£)
```

**é‡è¦ï¼š**
- æ–‡æ¡£çš„ `sort_order` åªåœ¨åˆ›å»ºæ—¶ä»æ¨¡æ¿å¤åˆ¶ä¸€æ¬¡
- ä¹‹åä¿®æ”¹æ¨¡æ¿çš„ `sort_order` ä¸ä¼šå½±å“å·²ç”Ÿæˆçš„æ–‡æ¡£
- å¯ä»¥ç‹¬ç«‹ä¿®æ”¹æ–‡æ¡£çš„ `sort_order`

## æ•°æ®åº“ç¤ºä¾‹

### ç”Ÿæˆæ–‡æ¡£

```sql
-- æ¨¡æ¿è¡¨
SELECT id, template_name, sort_order FROM document_template WHERE id = 1;
-- ç»“æœï¼šid=1, template_name='èµ·è¯‰çŠ¶', sort_order=1000

-- ç”Ÿæˆæ–‡æ¡£
INSERT INTO case_document (
    case_id, template_id, document_name, sort_order, create_datetime
) VALUES (
    50, 1, 'èµ·è¯‰çŠ¶', 1000, NOW()
);

-- æŸ¥è¯¢æ–‡æ¡£ï¼ˆæŒ‰ sort_order æ’åºï¼‰
SELECT id, document_name, sort_order 
FROM case_document 
WHERE case_id = 50 AND is_deleted = 0
ORDER BY sort_order, id;

-- ç»“æœï¼š
-- id | document_name | sort_order
-- 123| èµ·è¯‰çŠ¶        | 1000
-- 124| ç­”è¾©çŠ¶        | 2000
-- 125| è¯æ®æ¸…å•      | 3000
```

### æŸ¥çœ‹æ–‡æ¡£æ ‘

```sql
-- æŸ¥è¯¢æŸä¸ªæ¡ˆä»¶çš„æ‰€æœ‰æ–‡æ¡£ï¼ˆå¸¦æ’åºï¼‰
SELECT 
    cd.id,
    cd.document_name,
    cd.sort_order,
    cd.print_count,
    dt.template_name,
    dt.sort_order as template_sort_order
FROM case_document cd
LEFT JOIN document_template dt ON cd.template_id = dt.id
WHERE cd.case_id = 50 AND cd.is_deleted = 0
ORDER BY cd.sort_order, cd.id;
```

## å‰ç«¯ç¤ºä¾‹

### æ˜¾ç¤ºæ’åºåºå·

```vue
<template>
  <el-table :data="documents">
    <el-table-column label="æ’åº" width="80">
      <template #default="{ row }">
        <el-tag size="small" type="info">{{ row.sort_order }}</el-tag>
      </template>
    </el-table-column>
    <el-table-column prop="label" label="æ–‡æ¡£åç§°" />
    <el-table-column prop="print_count" label="æ‰“å°ä»½æ•°" />
  </el-table>
</template>

<script setup>
import { ref, onMounted } from 'vue';

const documents = ref([]);

onMounted(async () => {
  const response = await axios.get('/api/case/cases/50/document_tree/');
  const tree = response.data.data;
  
  // æå–æ‰€æœ‰æ–‡æ¡£
  documents.value = [];
  tree.forEach(folder => {
    if (folder.children) {
      documents.value.push(...folder.children);
    }
  });
  
  // æ–‡æ¡£å·²æŒ‰ sort_order æ’åº
  console.log('æ–‡æ¡£åˆ—è¡¨:', documents.value);
});
</script>
```

## è¿ç§»æ­¥éª¤

### 1. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
python manage.py migrate
```

### 2. ä¸ºç°æœ‰æ–‡æ¡£è®¾ç½®æ’åº

```python
# å¯é€‰ï¼šä¸ºç°æœ‰æ–‡æ¡£ä»æ¨¡æ¿å¤åˆ¶ sort_order
from case_management.models import CaseDocument

documents = CaseDocument.objects.filter(
    template__isnull=False,
    is_deleted=False
).select_related('template')

for doc in documents:
    doc.sort_order = doc.template.sort_order
    
CaseDocument.objects.bulk_update(documents, ['sort_order'])
```

## ç›¸å…³æ–‡ä»¶

- **æ¨¡å‹**: `case_management/models.py` - `CaseDocument`
- **å·¥å…·å‡½æ•°**: `case_management/utils/folder_helper.py` - `get_case_document_tree()`
- **æœåŠ¡**: `case_management/placeholder_template_service.py`
  - `fill_and_save_by_record()`
  - `save_docx_document()`
  - `save_text_document()`
- **è¿ç§»**: `case_management/migrations/0015_add_case_document_sort_order.py`

## æ€»ç»“

âœ… **å·²å®ç°ï¼š**
- [x] `CaseDocument` æ·»åŠ  `sort_order` å­—æ®µï¼ˆå¸¦ç´¢å¼•ï¼‰
- [x] æ–‡æ¡£æ ‘æŒ‰ `sort_order` å‡åºæ’åˆ—
- [x] ç”Ÿæˆæ–‡ä¹¦æ—¶ä»æ¨¡æ¿å¤åˆ¶ `sort_order`
- [x] æ–‡æ¡£æ ‘è¿”å›æ•°æ®ä¸­åŒ…å« `sort_order`
- [x] åˆ›å»ºæ•°æ®åº“è¿ç§»æ–‡ä»¶

âœ… **æ•ˆæœï¼š**
- æ–‡æ¡£åœ¨æ–‡æ¡£æ ‘ä¸­æŒ‰ç…§æ¨¡æ¿å®šä¹‰çš„é¡ºåºæ˜¾ç¤º
- æ•°å€¼è¶Šå°çš„æ–‡æ¡£è¶Šé å‰
- å¯ä»¥ç‹¬ç«‹è°ƒæ•´æ–‡æ¡£çš„æ’åº
- æé«˜æŸ¥è¯¢æ€§èƒ½ï¼ˆå·²æ·»åŠ ç´¢å¼•ï¼‰

âœ… **æ•°æ®æµå‘ï¼š**
```
DocumentTemplate.sort_order
         â†“
   (ç”Ÿæˆæ—¶å¤åˆ¶)
         â†“
CaseDocument.sort_order
         â†“
  (æŸ¥è¯¢æ—¶æ’åº)
         â†“
    æ–‡æ¡£æ ‘æ˜¾ç¤º
```

ç°åœ¨æ–‡æ¡£ä¼šæŒ‰ç…§æ¨¡æ¿å®šä¹‰çš„é¡ºåºåœ¨æ–‡æ¡£æ ‘ä¸­æ˜¾ç¤ºäº†ï¼ğŸ‰

