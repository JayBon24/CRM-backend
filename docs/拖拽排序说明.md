# 拖拽排序功能说明

## 前端发送参数

### API 接口
```
POST /api/case/document-templates/batch-sort/
```

### 请求数据格式
```json
{
  "templates": [
    {
      "id": 5,
      "sort_order": 2500
    }
  ]
}
```

### 字段说明
- `templates`: 数组，包含需要更新的模板
- `id`: 模板ID
- `sort_order`: 新的排序值

### 优化策略
采用**间隔编号法**，只更新被移动的项目：
- 正常拖拽：只发送1个项目
- 间隔不足时：自动重整，发送所有项目

## 后端接收处理

### Django 示例

```python
from django.db import transaction
from rest_framework.decorators import action
from rest_framework.response import Response

class DocumentTemplateViewSet(viewsets.ModelViewSet):
    
    @action(detail=False, methods=['post'], url_path='batch-sort')
    def batch_sort(self, request):
        """批量更新模板排序"""
        try:
            templates_data = request.data.get('templates', [])
            
            if not templates_data:
                return Response({
                    'code': 4000,
                    'msg': '没有提供排序数据'
                })
            
            # 使用事务批量更新
            with transaction.atomic():
                template_ids = [item['id'] for item in templates_data]
                templates = DocumentTemplate.objects.filter(id__in=template_ids)
                
                # 创建ID到sort_order的映射
                sort_map = {item['id']: item['sort_order'] for item in templates_data}
                
                # 更新sort_order
                for template in templates:
                    template.sort_order = sort_map.get(template.id)
                
                # 批量保存
                DocumentTemplate.objects.bulk_update(templates, ['sort_order'])
            
            return Response({
                'code': 2000,
                'msg': f'成功更新 {len(templates)} 个模板的排序'
            })
            
        except Exception as e:
            return Response({
                'code': 5000,
                'msg': f'更新排序失败: {str(e)}'
            })
```

### 处理步骤
1. 接收 `templates` 数组
2. 提取所有 `id`
3. 查询对应的模板对象
4. 更新 `sort_order` 字段
5. 批量保存（使用 `bulk_update` 提高性能）
6. 返回成功响应

## 数据库字段

```python
class DocumentTemplate(models.Model):
    sort_order = models.IntegerField(default=0, verbose_name='排序', db_index=True)
    
    class Meta:
        ordering = ['sort_order', 'id']
```

**注意**：建议给 `sort_order` 添加索引以提高查询性能。

