# 项目结构与开发指南（lsl-backend）

## 1. 项目概览

- **框架**：Django 4.2 + Django REST Framework（DRF）
- **运行方式**：ASGI（Uvicorn/Gunicorn），入口 `application.asgi:application`
- **鉴权**：JWT（`rest_framework_simplejwt`），请求头支持 `Authorization: Bearer <token>` 或 `Authorization: JWT <token>`
- **统一响应**：`dvadmin.utils.json_response`（成功 `code=2000`，异常默认 `code=4000`）

## 2. 启动与环境配置

### 2.1 环境与依赖

- Python 3.11.x
- 依赖：`requirements.txt`

### 2.2 配置文件

- 复制：`conf/env.example.py` -> `conf/env.py`
- 关键配置：
  - `DATABASE_ENGINE / DATABASE_NAME / DATABASE_HOST / DATABASE_USER / DATABASE_PASSWORD / DATABASE_PORT`
  - Redis（可选）
  - DEBUG 等开关

> `application/settings.py` 会 `from conf.env import *`，所以 `conf/env.py` 是运行时关键配置。

### 2.3 启动方式

- Windows（开发）：`dev_start.bat`
- Windows（生产）：`prod_start.bat` 或 `quick_start.bat`
- 手动：
  - 开发热更新：`uvicorn application.asgi:application --reload --host 0.0.0.0 --port 8000`
  - 或：`python main.py`

## 3. 顶层目录功能说明

- **`application/`**：项目级配置与入口
  - `settings.py`：Django 配置（安装 app、中间件、DRF、JWT、Swagger 等）
  - `urls.py`：全局路由入口
  - `asgi.py`：ASGI 入口（channels 的 `ProtocolTypeRouter`）
  - `dispatch.py`：启动期加载系统配置/字典（数据库未迁移会提示“请先进行数据库迁移!”）

- **`case_management/`**：案件管理业务 app（核心业务）
  - `models.py`：业务实体
  - `serializers.py`：序列化与参数校验
  - `views.py`：控制器（ViewSet/函数视图），大量业务 action
  - `urls.py`：该 app 路由注册（`DefaultRouter`）
  - `utils/`：文件处理/转换/图片等工具
  - `management/commands/`：自定义管理命令（初始化数据、菜单权限等）
  - `migrations/`：Django 迁移文件

- **`dvadmin/`**：通用后台能力基座
  - `dvadmin.utils.*`：统一响应、异常、通用 ViewSet、基础模型等
  - `dvadmin.system/`：用户/角色/菜单/字典/系统配置等系统模块

- **`conf/`**：环境配置
- **`docs/`**：项目文档
- **`static/` / `templates/` / `media/`**：静态资源、模板、媒体文件
- **`plugins/`**：插件扩展目录（会被加入 `sys.path` 且可挂载到路由）

## 4. 路由与模块挂载

全局路由在 `application/urls.py`：

- **系统模块**：`/api/system/` -> `dvadmin.system.urls`
- **案件模块**：`/api/case/` -> `case_management.urls`

此外 Swagger UI 默认映射在根路径：
- `/`：Swagger UI
- `/redoc/`：ReDoc

## 5. 标准开发方式：模型/控制器/服务怎么写

### 5.1 实体模型（Model）

项目内常用的基类位于 `dvadmin/utils/models.py`：

- `CoreModel`：提供审计字段（`id/create_datetime/update_datetime/creator/modifier/...`）
- `SoftDeleteModel`：提供软删除（`is_deleted` + 重写 `delete()`）

推荐：
- 需要审计字段：继承 `CoreModel`
- 需要软删除：再继承 `SoftDeleteModel`
- `Meta.db_table`：保持与现有 app 一致（多处显式指定表名）

### 5.2 序列化器（Serializer）

- 用 `serializers.ModelSerializer` 描述输入/输出
- 对 action 的请求体，建议单独定义 Serializer（用于校验与 Swagger 展示）
- 只读字段：通常包含 `id/create_datetime/update_datetime` 等

### 5.3 控制器（Controller / View）

推荐使用 `dvadmin.utils.viewset.CustomModelViewSet`：

- 自动统一返回格式：
  - `create` -> `DetailResponse`
  - `list` -> `SuccessResponse`（分页时走自定义分页器）
  - `retrieve/update/destroy` -> `DetailResponse`
- 支持 action：使用 `@action` 定义非 CRUD 的业务接口

### 5.4 服务层（Service）

项目内大量复杂逻辑并不放在 ViewSet 内，而是拆到：

- `xxx_service.py`（AI/模板/占位符/文书生成等）
- `utils/`（文件管理、转换、图片处理等）

推荐约束：
- **`views.py`**：只做
  - 参数接收
  - serializer 校验
  - 权限检查
  - 调用 service
  - 返回 `SuccessResponse/DetailResponse/ErrorResponse`
- **service**：负责
  - 跨模型事务（必要时 `transaction.atomic()`）
  - 文件系统读写
  - 调用第三方（AI/WPS）
  - 失败抛异常交给全局异常处理器

## 6. 数据库迁移与初始化：会不会自动迁移？

### 6.1 结论

- **不会自动迁移。**
  - `dev_start.bat / prod_start.bat / quick_start.bat` 均未执行 `migrate`
  - `docker_start.sh` 中的 `migrate/init` 目前是注释状态

### 6.2 正确流程（建议）

1) 执行迁移（结构变更）：

- `python manage.py migrate`

2) 初始化数据（种子数据/菜单/字典/系统配置等）：

- `python manage.py init -y`

说明：
- `manage.py init -y` 对应 `dvadmin.system.management.commands.init`，作用是遍历 `INSTALLED_APPS` 执行 app 的初始化逻辑，**不负责迁移表结构**。

## 7. 常用开发清单（新增一个业务模块时）

- **[新增 app]**：创建 Django app 并加入 `INSTALLED_APPS`
- **[建模]**：`models.py` 定义模型（考虑继承 `CoreModel/SoftDeleteModel`）
- **[迁移]**：`makemigrations` + `migrate`
- **[序列化]**：`serializers.py` 定义 `ModelSerializer` 与 action Serializer
- **[控制器]**：`views.py` 新建 `ViewSet(CustomModelViewSet)` + `@action`
- **[路由]**：`urls.py` 通过 Router 注册
- **[文档]**：在 `docs/` 增加接口说明（按统一响应/鉴权规范）

