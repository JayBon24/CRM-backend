# æ–‡æ¡£æ ‘æ·»åŠ æ‰“å°æ•°é‡å­—æ®µè¯´æ˜

## ä¿®æ”¹æ—¶é—´
2025-10-30

## é—®é¢˜æè¿°

`/api/case/cases/{id}/document_tree/` æ¥å£è¿”å›çš„æ–‡æ¡£æ ‘ç»“æ„ä¸­ï¼Œæ–‡æ¡£èŠ‚ç‚¹ï¼ˆchildrenåˆ—è¡¨ä¸­çš„æ–‡æ¡£é¡¹ï¼‰ç¼ºå°‘ `print_count` å­—æ®µã€‚

## ä¿®æ”¹å†…å®¹

åœ¨ `case_management/utils/folder_helper.py` çš„ `get_case_document_tree()` å‡½æ•°ä¸­ï¼Œä¸ºæ–‡æ¡£èŠ‚ç‚¹æ·»åŠ  `print_count` å­—æ®µã€‚

### ä¿®æ”¹å‰

```python
doc_node = {
    'id': f"doc_{doc.id}",
    'label': f"{doc.document_name}{doc.file_ext or ''}",
    'path': doc.file_url or '',
    'file_path': doc.file_path or '',
    'type': 'file',
    'document_id': doc.id,
    'file_size': doc.file_size,
    'document_type': doc.document_type,
    'version': doc.version,
    'created_at': doc.create_datetime.strftime('%Y-%m-%d %H:%M:%S') if doc.create_datetime else None
}
```

### ä¿®æ”¹å

```python
doc_node = {
    'id': f"doc_{doc.id}",
    'label': f"{doc.document_name}{doc.file_ext or ''}",
    'path': doc.file_url or '',
    'file_path': doc.file_path or '',
    'type': 'file',
    'document_id': doc.id,
    'file_size': doc.file_size,
    'document_type': doc.document_type,
    'version': doc.version,
    'print_count': doc.print_count,  # âœ… æ–°å¢ï¼šæ‰“å°æ•°é‡
    'created_at': doc.create_datetime.strftime('%Y-%m-%d %H:%M:%S') if doc.create_datetime else None
}
```

## API æ¥å£

### æ¥å£åœ°å€

```
GET /api/case/cases/{id}/document_tree/
```

### å“åº”æ ¼å¼

```json
{
  "code": 2000,
  "msg": "success",
  "data": [
    {
      "id": 1,
      "label": "æ¡ˆä»¶æ–‡ä¹¦",
      "path": "/case_documents",
      "type": "folder",
      "folder_type": "fixed",
      "children": [
        {
          "id": "doc_123",
          "label": "èµ·è¯‰çŠ¶.docx",
          "path": "/media/cases/50/case_documents/èµ·è¯‰çŠ¶.docx",
          "file_path": "cases/50/case_documents/èµ·è¯‰çŠ¶.docx",
          "type": "file",
          "document_id": 123,
          "file_size": 12345,
          "document_type": "word",
          "version": 1,
          "print_count": 3,
          "created_at": "2025-10-30 10:00:00"
        },
        {
          "id": "doc_124",
          "label": "ç­”è¾©çŠ¶.docx",
          "path": "/media/cases/50/case_documents/ç­”è¾©çŠ¶.docx",
          "file_path": "cases/50/case_documents/ç­”è¾©çŠ¶.docx",
          "type": "file",
          "document_id": 124,
          "file_size": 8900,
          "document_type": "word",
          "version": 1,
          "print_count": 2,
          "created_at": "2025-10-30 11:00:00"
        }
      ]
    },
    {
      "id": 2,
      "label": "è¯æ®ææ–™",
      "path": "/evidence",
      "type": "folder",
      "folder_type": "fixed",
      "children": []
    }
  ]
}
```

## å­—æ®µè¯´æ˜

### æ–‡æ¡£èŠ‚ç‚¹å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | String | æ–‡æ¡£èŠ‚ç‚¹IDï¼Œæ ¼å¼ï¼š`doc_{document_id}` |
| label | String | æ–‡æ¡£æ˜¾ç¤ºåç§°ï¼ˆåŒ…å«æ‰©å±•åï¼‰ |
| path | String | æ–‡ä»¶è®¿é—®URLè·¯å¾„ |
| file_path | String | æ–‡ä»¶ç›¸å¯¹è·¯å¾„ï¼ˆå­˜å‚¨è·¯å¾„ï¼‰ |
| type | String | èŠ‚ç‚¹ç±»å‹ï¼Œå›ºå®šä¸º `file` |
| document_id | Integer | æ–‡æ¡£è®°å½•ID |
| file_size | Integer | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| document_type | String | æ–‡æ¡£ç±»å‹ï¼ˆå¦‚ `word`ã€`pdf` ç­‰ï¼‰ |
| version | Integer | æ–‡æ¡£ç‰ˆæœ¬å· |
| **print_count** | **Integer** | **âœ… æ‰“å°æ•°é‡ï¼ˆæ–°å¢ï¼‰** |
| created_at | String | åˆ›å»ºæ—¶é—´ï¼Œæ ¼å¼ï¼š`YYYY-MM-DD HH:MM:SS` |

## ä½¿ç”¨åœºæ™¯

### 1. æ–‡æ¡£åˆ—è¡¨å±•ç¤º

```vue
<template>
  <el-tree :data="documentTree" :props="treeProps">
    <template #default="{ node, data }">
      <span v-if="data.type === 'file'">
        <i class="el-icon-document"></i>
        {{ data.label }}
        <el-tag size="small" type="info">
          æ‰“å° {{ data.print_count }} ä»½
        </el-tag>
      </span>
      <span v-else>
        <i class="el-icon-folder"></i>
        {{ data.label }}
      </span>
    </template>
  </el-tree>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import axios from 'axios';

const documentTree = ref([]);

onMounted(async () => {
  const response = await axios.get('/api/case/cases/50/document_tree/');
  documentTree.value = response.data.data;
});

const treeProps = {
  children: 'children',
  label: 'label'
};
</script>
```

### 2. æ‰¹é‡æ‰“å°åŠŸèƒ½

```javascript
// è·å–æ‰€æœ‰æ–‡æ¡£åŠå…¶æ‰“å°æ•°é‡
async function getAllDocumentsPrintInfo(caseId) {
  const response = await axios.get(`/api/case/cases/${caseId}/document_tree/`);
  const tree = response.data.data;
  
  // æå–æ‰€æœ‰æ–‡æ¡£
  const documents = [];
  tree.forEach(folder => {
    if (folder.children && folder.children.length > 0) {
      folder.children.forEach(doc => {
        documents.push({
          id: doc.document_id,
          name: doc.label,
          printCount: doc.print_count,
          path: doc.path
        });
      });
    }
  });
  
  return documents;
}

// è®¡ç®—æ€»æ‰“å°ä»½æ•°
async function calculateTotalCopies(caseId) {
  const documents = await getAllDocumentsPrintInfo(caseId);
  const total = documents.reduce((sum, doc) => sum + doc.printCount, 0);
  
  console.log(`æ¡ˆä»¶ ${caseId} æ‰€æœ‰æ–‡ä¹¦å…±éœ€æ‰“å° ${total} ä»½`);
  return total;
}

// ä½¿ç”¨
calculateTotalCopies(50);
// è¾“å‡ºï¼šæ¡ˆä»¶ 50 æ‰€æœ‰æ–‡ä¹¦å…±éœ€æ‰“å° 15 ä»½
```

### 3. æ‰“å°æ¸…å•

```javascript
// ç”Ÿæˆæ‰“å°æ¸…å•
async function generatePrintList(caseId) {
  const response = await axios.get(`/api/case/cases/${caseId}/document_tree/`);
  const tree = response.data.data;
  
  const printList = [];
  tree.forEach(folder => {
    if (folder.children && folder.children.length > 0) {
      folder.children.forEach(doc => {
        printList.push({
          folder: folder.label,
          document: doc.label,
          copies: doc.print_count,
          size: formatFileSize(doc.file_size)
        });
      });
    }
  });
  
  return printList;
}

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

// ä½¿ç”¨ç¤ºä¾‹
const printList = await generatePrintList(50);
console.table(printList);

// è¾“å‡ºï¼š
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ (index) â”‚   folder     â”‚   document     â”‚ copies â”‚   size   â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚    0    â”‚  'æ¡ˆä»¶æ–‡ä¹¦'   â”‚  'èµ·è¯‰çŠ¶.docx'  â”‚   3    â”‚ '12.05 KB'â”‚
// â”‚    1    â”‚  'æ¡ˆä»¶æ–‡ä¹¦'   â”‚  'ç­”è¾©çŠ¶.docx'  â”‚   2    â”‚  '8.69 KB'â”‚
// â”‚    2    â”‚  'è¯æ®ææ–™'   â”‚ 'è¯æ®æ¸…å•.pdf'  â”‚   5    â”‚ '45.20 KB'â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å‰ç«¯ç¤ºä¾‹

### å®Œæ•´çš„æ–‡æ¡£æ ‘ç»„ä»¶ï¼ˆå¸¦æ‰“å°æ•°é‡ï¼‰

```vue
<template>
  <div class="document-tree">
    <el-tree
      :data="treeData"
      :props="treeProps"
      :default-expand-all="true"
      node-key="id"
    >
      <template #default="{ node, data }">
        <div class="custom-tree-node">
          <div class="node-content">
            <i :class="getIcon(data.type)"></i>
            <span class="node-label">{{ data.label }}</span>
          </div>
          
          <!-- æ–‡ä»¶èŠ‚ç‚¹æ˜¾ç¤ºæ‰“å°æ•°é‡ -->
          <div v-if="data.type === 'file'" class="node-actions">
            <el-tag size="small" type="info">
              {{ data.print_count }} ä»½
            </el-tag>
            <el-button
              size="small"
              type="text"
              icon="el-icon-edit"
              @click.stop="editPrintCount(data)"
            >
              ä¿®æ”¹
            </el-button>
            <el-button
              size="small"
              type="text"
              icon="el-icon-download"
              @click.stop="downloadDocument(data)"
            >
              ä¸‹è½½
            </el-button>
          </div>
        </div>
      </template>
    </el-tree>
    
    <!-- æ‰“å°æ•°é‡ç»Ÿè®¡ -->
    <div class="print-summary">
      <el-divider />
      <p>æ€»æ‰“å°ä»½æ•°: <strong>{{ totalPrintCount }}</strong> ä»½</p>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue';
import { ElMessage, ElMessageBox } from 'element-plus';
import axios from 'axios';

const props = defineProps({
  caseId: {
    type: Number,
    required: true
  }
});

const treeData = ref([]);

const treeProps = {
  children: 'children',
  label: 'label'
};

// è®¡ç®—æ€»æ‰“å°ä»½æ•°
const totalPrintCount = computed(() => {
  let total = 0;
  treeData.value.forEach(folder => {
    if (folder.children) {
      folder.children.forEach(doc => {
        total += doc.print_count || 0;
      });
    }
  });
  return total;
});

// è·å–å›¾æ ‡
const getIcon = (type) => {
  return type === 'folder' ? 'el-icon-folder' : 'el-icon-document';
};

// åŠ è½½æ–‡æ¡£æ ‘
const loadDocumentTree = async () => {
  try {
    const response = await axios.get(`/api/case/cases/${props.caseId}/document_tree/`);
    if (response.data.code === 2000) {
      treeData.value = response.data.data;
    }
  } catch (error) {
    ElMessage.error('åŠ è½½æ–‡æ¡£æ ‘å¤±è´¥');
    console.error(error);
  }
};

// ä¿®æ”¹æ‰“å°æ•°é‡
const editPrintCount = async (data) => {
  try {
    const { value } = await ElMessageBox.prompt(
      'è¯·è¾“å…¥æ–°çš„æ‰“å°ä»½æ•°',
      'ä¿®æ”¹æ‰“å°æ•°é‡',
      {
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ',
        inputValue: data.print_count.toString(),
        inputValidator: (value) => {
          const num = parseInt(value);
          if (isNaN(num) || num < 1 || num > 99) {
            return 'è¯·è¾“å…¥1-99ä¹‹é—´çš„æ•°å­—';
          }
          return true;
        }
      }
    );
    
    const newCount = parseInt(value);
    
    // è°ƒç”¨æ‰¹é‡æ›´æ–°æ¥å£
    const response = await axios.post('/api/case/documents/batch-update-print-count/', {
      documents: [
        {
          id: data.document_id,
          print_count: newCount
        }
      ]
    });
    
    if (response.data.code === 2000) {
      data.print_count = newCount;
      ElMessage.success('æ‰“å°æ•°é‡æ›´æ–°æˆåŠŸ');
    } else {
      ElMessage.error(response.data.msg);
    }
  } catch (error) {
    if (error !== 'cancel') {
      console.error(error);
    }
  }
};

// ä¸‹è½½æ–‡æ¡£
const downloadDocument = (data) => {
  window.open(data.path, '_blank');
};

onMounted(() => {
  loadDocumentTree();
});
</script>

<style scoped>
.document-tree {
  padding: 20px;
}

.custom-tree-node {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  padding-right: 10px;
}

.node-content {
  display: flex;
  align-items: center;
  gap: 8px;
}

.node-label {
  font-size: 14px;
}

.node-actions {
  display: flex;
  align-items: center;
  gap: 8px;
}

.print-summary {
  margin-top: 20px;
  text-align: right;
}

.print-summary strong {
  color: #409eff;
  font-size: 18px;
}
</style>
```

## ç›¸å…³æ–‡ä»¶

- **å·¥å…·å‡½æ•°**: `case_management/utils/folder_helper.py` - `get_case_document_tree()`
- **è§†å›¾**: `case_management/views.py` - `CaseManagementViewSet.document_tree()`
- **æ¨¡å‹**: `case_management/models.py` - `CaseDocument`

## ç›¸å…³æ¥å£

- `GET /api/case/cases/{id}/document_tree/` - è·å–æ–‡æ¡£æ ‘ï¼ˆå·²åŒ…å« print_countï¼‰
- `POST /api/case/documents/batch-update-print-count/` - æ‰¹é‡æ›´æ–°æ‰“å°æ•°é‡

## æ€»ç»“

âœ… **å·²ä¿®æ”¹ï¼š**
- [x] åœ¨æ–‡æ¡£æ ‘çš„æ–‡æ¡£èŠ‚ç‚¹ä¸­æ·»åŠ  `print_count` å­—æ®µ
- [x] æ–‡æ¡£æ ‘è¿”å›çš„æ¯ä¸ªæ–‡æ¡£éƒ½åŒ…å«æ‰“å°æ•°é‡ä¿¡æ¯
- [x] å‰ç«¯å¯ä»¥ç›´æ¥ä»æ–‡æ¡£æ ‘è·å–æ‰“å°æ•°é‡

âœ… **å½±å“èŒƒå›´ï¼š**
- æ¥å£ï¼š`/api/case/cases/{id}/document_tree/`
- è¿”å›æ•°æ®ï¼šæ–‡æ¡£èŠ‚ç‚¹æ–°å¢ `print_count` å­—æ®µ
- å…¼å®¹æ€§ï¼šå‘ä¸‹å…¼å®¹ï¼Œæ–°å¢å­—æ®µä¸å½±å“ç°æœ‰åŠŸèƒ½

ç°åœ¨å‰ç«¯å¯ä»¥ç›´æ¥ä»æ–‡æ¡£æ ‘ä¸­è·å–æ¯ä¸ªæ–‡æ¡£çš„æ‰“å°æ•°é‡äº†ï¼ğŸ‰

