# æ‹–æ‹½æ’åºåŠŸèƒ½å®ç°è¯´æ˜

## å®ç°æ—¶é—´
2025-10-30

## åŠŸèƒ½æ¦‚è¿°

ä¸º `DocumentTemplate`ï¼ˆæ–‡æ¡£æ¨¡æ¿ï¼‰å®ç°äº†æ‹–æ‹½æ’åºåŠŸèƒ½ï¼Œæ”¯æŒå‰ç«¯é€šè¿‡æ‹–æ‹½è°ƒæ•´æ¨¡æ¿é¡ºåºã€‚

## å®ç°å†…å®¹

### 1. æ•°æ®åº“å­—æ®µ

åœ¨ `DocumentTemplate` æ¨¡å‹ä¸­å·²æ·»åŠ  `sort_order` å­—æ®µï¼š

```python
class DocumentTemplate(CoreModel, SoftDeleteModel):
    # ... å…¶ä»–å­—æ®µ
    
    sort_order = models.IntegerField(
        default=0, 
        verbose_name="æ’åºåºå·", 
        help_text="æ’åºåºå·ï¼Œæ•°å€¼è¶Šå°è¶Šé å‰",
        db_index=True  # æ·»åŠ ç´¢å¼•æé«˜æŸ¥è¯¢æ€§èƒ½
    )
    
    class Meta:
        ordering = ['sort_order', 'id']  # æŒ‰ sort_order æ’åºï¼Œç›¸åŒæ—¶æŒ‰ id æ’åº
```

**ç‰¹ç‚¹ï¼š**
- é»˜è®¤å€¼ä¸º 0
- æ·»åŠ äº†æ•°æ®åº“ç´¢å¼• (`db_index=True`)
- æ¨¡å‹çº§åˆ«è®¾ç½®äº†æ’åºè§„åˆ™

### 2. åºåˆ—åŒ–å™¨

åˆ›å»ºäº†ä¸¤ä¸ªåºåˆ—åŒ–å™¨ç”¨äºéªŒè¯æ‰¹é‡æ’åºè¯·æ±‚ï¼š

#### TemplateSortItemSerializer
```python
class TemplateSortItemSerializer(serializers.Serializer):
    """å•ä¸ªæ¨¡æ¿æ’åºé¡¹åºåˆ—åŒ–å™¨"""
    id = serializers.IntegerField(required=True, help_text="æ¨¡æ¿ID")
    sort_order = serializers.IntegerField(required=True, help_text="æ–°çš„æ’åºå€¼")
```

#### BatchSortSerializer
```python
class BatchSortSerializer(serializers.Serializer):
    """æ‰¹é‡æ’åºåºåˆ—åŒ–å™¨"""
    templates = TemplateSortItemSerializer(many=True, required=True, help_text="éœ€è¦æ›´æ–°æ’åºçš„æ¨¡æ¿åˆ—è¡¨")
    
    def validate_templates(self, value):
        """éªŒè¯æ¨¡æ¿åˆ—è¡¨"""
        if not value:
            raise serializers.ValidationError("æ¨¡æ¿åˆ—è¡¨ä¸èƒ½ä¸ºç©º")
        
        # æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„ID
        ids = [item['id'] for item in value]
        if len(ids) != len(set(ids)):
            raise serializers.ValidationError("æ¨¡æ¿IDä¸èƒ½é‡å¤")
        
        return value
```

**éªŒè¯è§„åˆ™ï¼š**
- æ¨¡æ¿åˆ—è¡¨ä¸èƒ½ä¸ºç©º
- æ¨¡æ¿ ID ä¸èƒ½é‡å¤
- æ¯ä¸ªé¡¹å¿…é¡»åŒ…å« `id` å’Œ `sort_order`

### 3. API æ¥å£

åœ¨ `DocumentTemplateViewSet` ä¸­æ·»åŠ äº† `batch_sort` actionï¼š

```python
@action(detail=False, methods=['post'], url_path='batch-sort')
def batch_sort(self, request):
    """æ‰¹é‡æ›´æ–°æ¨¡æ¿æ’åº"""
    try:
        # éªŒè¯è¯·æ±‚æ•°æ®
        from .serializers import BatchSortSerializer
        serializer = BatchSortSerializer(data=request.data)
        if not serializer.is_valid():
            return ErrorResponse(msg=f"æ•°æ®éªŒè¯å¤±è´¥: {serializer.errors}")
        
        templates_data = serializer.validated_data['templates']
        
        # ä½¿ç”¨äº‹åŠ¡æ‰¹é‡æ›´æ–°
        from django.db import transaction
        
        with transaction.atomic():
            # æå–æ‰€æœ‰æ¨¡æ¿ID
            template_ids = [item['id'] for item in templates_data]
            
            # æŸ¥è¯¢å¯¹åº”çš„æ¨¡æ¿å¯¹è±¡
            templates = DocumentTemplate.objects.filter(id__in=template_ids)
            
            # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ¨¡æ¿éƒ½å­˜åœ¨
            found_ids = set(t.id for t in templates)
            missing_ids = set(template_ids) - found_ids
            if missing_ids:
                return ErrorResponse(msg=f"æ¨¡æ¿ä¸å­˜åœ¨: {list(missing_ids)}")
            
            # åˆ›å»ºIDåˆ°sort_orderçš„æ˜ å°„
            sort_map = {item['id']: item['sort_order'] for item in templates_data}
            
            # æ›´æ–°sort_order
            for template in templates:
                template.sort_order = sort_map[template.id]
            
            # æ‰¹é‡ä¿å­˜
            DocumentTemplate.objects.bulk_update(templates, ['sort_order'])
        
        logger.info(f"æˆåŠŸæ›´æ–° {len(templates)} ä¸ªæ¨¡æ¿çš„æ’åº")
        
        return DetailResponse(
            data={
                'updated_count': len(templates),
                'updated_ids': template_ids
            },
            msg=f"æˆåŠŸæ›´æ–° {len(templates)} ä¸ªæ¨¡æ¿çš„æ’åº"
        )
        
    except Exception as e:
        logger.error(f"æ‰¹é‡æ›´æ–°æ’åºå¤±è´¥: {str(e)}")
        return ErrorResponse(msg=f"æ›´æ–°æ’åºå¤±è´¥: {str(e)}")
```

**æ ¸å¿ƒç‰¹æ€§ï¼š**
1. **æ•°æ®éªŒè¯**ï¼šä½¿ç”¨åºåˆ—åŒ–å™¨éªŒè¯è¯·æ±‚æ•°æ®
2. **äº‹åŠ¡ä¿æŠ¤**ï¼šä½¿ç”¨ `transaction.atomic()` ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
3. **æ‰¹é‡æ›´æ–°**ï¼šä½¿ç”¨ `bulk_update` æé«˜æ€§èƒ½
4. **é”™è¯¯å¤„ç†**ï¼šæ£€æŸ¥æ¨¡æ¿æ˜¯å¦å­˜åœ¨ï¼Œè¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯
5. **æ—¥å¿—è®°å½•**ï¼šè®°å½•æ›´æ–°æ“ä½œå’Œé”™è¯¯

## API ä½¿ç”¨è¯´æ˜

### æ¥å£åœ°å€

```
POST /api/case/document-templates/batch-sort/
```

### è¯·æ±‚æ ¼å¼

```json
{
  "templates": [
    {
      "id": 5,
      "sort_order": 2500
    },
    {
      "id": 3,
      "sort_order": 1500
    }
  ]
}
```

### è¯·æ±‚å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| templates | Array | æ˜¯ | éœ€è¦æ›´æ–°çš„æ¨¡æ¿åˆ—è¡¨ |
| templates[].id | Integer | æ˜¯ | æ¨¡æ¿ID |
| templates[].sort_order | Integer | æ˜¯ | æ–°çš„æ’åºå€¼ |

### æˆåŠŸå“åº”

```json
{
  "code": 2000,
  "msg": "æˆåŠŸæ›´æ–° 2 ä¸ªæ¨¡æ¿çš„æ’åº",
  "data": {
    "updated_count": 2,
    "updated_ids": [5, 3]
  }
}
```

### é”™è¯¯å“åº”

#### 1. æ•°æ®éªŒè¯å¤±è´¥
```json
{
  "code": 4000,
  "msg": "æ•°æ®éªŒè¯å¤±è´¥: {'templates': ['æ¨¡æ¿åˆ—è¡¨ä¸èƒ½ä¸ºç©º']}"
}
```

#### 2. æ¨¡æ¿IDé‡å¤
```json
{
  "code": 4000,
  "msg": "æ•°æ®éªŒè¯å¤±è´¥: {'templates': ['æ¨¡æ¿IDä¸èƒ½é‡å¤']}"
}
```

#### 3. æ¨¡æ¿ä¸å­˜åœ¨
```json
{
  "code": 4000,
  "msg": "æ¨¡æ¿ä¸å­˜åœ¨: [99, 100]"
}
```

#### 4. ç³»ç»Ÿé”™è¯¯
```json
{
  "code": 5000,
  "msg": "æ›´æ–°æ’åºå¤±è´¥: æ•°æ®åº“è¿æ¥å¤±è´¥"
}
```

## å‰ç«¯è°ƒç”¨ç¤ºä¾‹

### JavaScript (Axios)

```javascript
import axios from 'axios';

// æ‰¹é‡æ›´æ–°æ’åº
async function updateTemplateSort(templates) {
  try {
    const response = await axios.post(
      '/api/case/document-templates/batch-sort/',
      {
        templates: templates
      }
    );
    
    if (response.data.code === 2000) {
      console.log('æ’åºæ›´æ–°æˆåŠŸ:', response.data.msg);
      return true;
    } else {
      console.error('æ’åºæ›´æ–°å¤±è´¥:', response.data.msg);
      return false;
    }
  } catch (error) {
    console.error('è¯·æ±‚å¤±è´¥:', error);
    return false;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const templatesData = [
  { id: 5, sort_order: 2500 },
  { id: 3, sort_order: 1500 }
];

updateTemplateSort(templatesData);
```

### æ‹–æ‹½æ’åºå®Œæ•´ç¤ºä¾‹

```javascript
// ä½¿ç”¨é—´éš”ç¼–å·æ³•ï¼ˆæ¨èï¼‰
const SORT_GAP = 1000; // æ’åºé—´éš”

function handleDragEnd(result) {
  if (!result.destination) return;
  
  const items = Array.from(templateList);
  const [moved] = items.splice(result.source.index, 1);
  items.splice(result.destination.index, 0, moved);
  
  // è®¡ç®—æ–°çš„ sort_order
  const destinationIndex = result.destination.index;
  let newSortOrder;
  
  if (destinationIndex === 0) {
    // ç§»åˆ°æœ€å‰é¢
    newSortOrder = items[1].sort_order - SORT_GAP;
  } else if (destinationIndex === items.length - 1) {
    // ç§»åˆ°æœ€åé¢
    newSortOrder = items[items.length - 2].sort_order + SORT_GAP;
  } else {
    // ç§»åˆ°ä¸­é—´
    const prevOrder = items[destinationIndex - 1].sort_order;
    const nextOrder = items[destinationIndex + 1].sort_order;
    newSortOrder = Math.floor((prevOrder + nextOrder) / 2);
    
    // æ£€æŸ¥é—´éš”æ˜¯å¦è¶³å¤Ÿ
    if (nextOrder - prevOrder < 2) {
      // é—´éš”ä¸è¶³ï¼Œéœ€è¦é‡æ•´æ‰€æœ‰é¡¹
      return reorderAll(items);
    }
  }
  
  // åªæ›´æ–°è¢«ç§»åŠ¨çš„é¡¹
  updateTemplateSort([
    { id: moved.id, sort_order: newSortOrder }
  ]);
}

// é‡æ•´æ‰€æœ‰é¡¹çš„æ’åº
function reorderAll(items) {
  const updates = items.map((item, index) => ({
    id: item.id,
    sort_order: (index + 1) * SORT_GAP
  }));
  
  updateTemplateSort(updates);
}
```

## æŸ¥è¯¢æ’åºåçš„æ•°æ®

### API æŸ¥è¯¢

```http
GET /api/case/document-templates/
```

ç”±äºæ¨¡å‹ä¸­è®¾ç½®äº† `ordering = ['sort_order', 'id']`ï¼ŒæŸ¥è¯¢ç»“æœä¼šè‡ªåŠ¨æŒ‰ `sort_order` æ’åºã€‚

### å“åº”ç¤ºä¾‹

```json
{
  "code": 2000,
  "data": {
    "results": [
      {
        "id": 3,
        "template_name": "èµ·è¯‰çŠ¶",
        "sort_order": 1000
      },
      {
        "id": 5,
        "template_name": "ç­”è¾©çŠ¶",
        "sort_order": 2000
      },
      {
        "id": 7,
        "template_name": "è¯æ®æ¸…å•",
        "sort_order": 3000
      }
    ]
  }
}
```

## æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ç´¢å¼•

`sort_order` å­—æ®µæ·»åŠ äº†ç´¢å¼•ï¼š
```python
sort_order = models.IntegerField(db_index=True)
```

### 2. æ‰¹é‡æ›´æ–°

ä½¿ç”¨ `bulk_update` è€Œéå¾ªç¯ `save()`ï¼š
```python
# âŒ æ€§èƒ½å·®
for template in templates:
    template.sort_order = new_value
    template.save()

# âœ… æ€§èƒ½å¥½
for template in templates:
    template.sort_order = new_value
DocumentTemplate.objects.bulk_update(templates, ['sort_order'])
```

### 3. äº‹åŠ¡ä¿æŠ¤

ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼š
```python
with transaction.atomic():
    # æ‰€æœ‰æ›´æ–°æ“ä½œ
    DocumentTemplate.objects.bulk_update(templates, ['sort_order'])
```

### 4. é—´éš”ç¼–å·æ³•

å‰ç«¯ä½¿ç”¨é—´éš”ç¼–å·æ³•ï¼Œå‡å°‘éœ€è¦æ›´æ–°çš„è®°å½•æ•°ï¼š
- æ­£å¸¸æƒ…å†µï¼šåªæ›´æ–° 1 æ¡è®°å½•
- é—´éš”ä¸è¶³ï¼šé‡æ•´æ‰€æœ‰è®°å½•

## æ•°æ®åº“è¿ç§»

éœ€è¦è¿è¡Œè¿ç§»ä»¥æ·»åŠ  `sort_order` å­—æ®µï¼š

```bash
python manage.py migrate
```

è¿ç§»æ–‡ä»¶ï¼š`case_management/migrations/0014_add_sort_and_print_fields.py`

## æµ‹è¯•ç¤ºä¾‹

### å•å…ƒæµ‹è¯•

```python
from django.test import TestCase
from rest_framework.test import APIClient
from case_management.models import DocumentTemplate

class TemplateSortTestCase(TestCase):
    def setUp(self):
        self.client = APIClient()
        self.template1 = DocumentTemplate.objects.create(
            template_name="æ¨¡æ¿1",
            sort_order=1000
        )
        self.template2 = DocumentTemplate.objects.create(
            template_name="æ¨¡æ¿2",
            sort_order=2000
        )
    
    def test_batch_sort(self):
        """æµ‹è¯•æ‰¹é‡æ’åº"""
        response = self.client.post(
            '/api/case/document-templates/batch-sort/',
            {
                'templates': [
                    {'id': self.template1.id, 'sort_order': 3000},
                    {'id': self.template2.id, 'sort_order': 1000}
                ]
            },
            format='json'
        )
        
        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data['code'], 2000)
        
        # éªŒè¯æ’åºå·²æ›´æ–°
        self.template1.refresh_from_db()
        self.template2.refresh_from_db()
        self.assertEqual(self.template1.sort_order, 3000)
        self.assertEqual(self.template2.sort_order, 1000)
    
    def test_invalid_template_id(self):
        """æµ‹è¯•æ— æ•ˆçš„æ¨¡æ¿ID"""
        response = self.client.post(
            '/api/case/document-templates/batch-sort/',
            {
                'templates': [
                    {'id': 9999, 'sort_order': 1000}
                ]
            },
            format='json'
        )
        
        self.assertEqual(response.data['code'], 4000)
        self.assertIn('æ¨¡æ¿ä¸å­˜åœ¨', response.data['msg'])
```

### æ‰‹åŠ¨æµ‹è¯•

ä½¿ç”¨ Postman æˆ– cURLï¼š

```bash
curl -X POST http://localhost:8000/api/case/document-templates/batch-sort/ \
  -H "Content-Type: application/json" \
  -d '{
    "templates": [
      {"id": 1, "sort_order": 1000},
      {"id": 2, "sort_order": 2000}
    ]
  }'
```

## æ³¨æ„äº‹é¡¹

1. **sort_order æ•°å€¼é€‰æ‹©**
   - å»ºè®®ä½¿ç”¨è¾ƒå¤§çš„é—´éš”ï¼ˆå¦‚ 1000ï¼‰
   - ä¾¿äºåœ¨ä¸­é—´æ’å…¥æ–°é¡¹
   - é¿å…é¢‘ç¹é‡æ•´

2. **å¹¶å‘å¤„ç†**
   - ä½¿ç”¨äº‹åŠ¡ä¿æŠ¤æ•°æ®ä¸€è‡´æ€§
   - é¿å…åŒæ—¶å¤šä¸ªç”¨æˆ·ä¿®æ”¹æ’åº

3. **é»˜è®¤å€¼**
   - æ–°å»ºæ¨¡æ¿çš„ `sort_order` é»˜è®¤ä¸º 0
   - å¯ä»¥åœ¨åˆ›å»ºæ—¶è®¾ç½®åˆé€‚çš„åˆå§‹å€¼

4. **æŸ¥è¯¢æ€§èƒ½**
   - `sort_order` å·²æ·»åŠ ç´¢å¼•
   - å¤§é‡æ•°æ®æ—¶æ’åºæŸ¥è¯¢ä»ç„¶é«˜æ•ˆ

## ç›¸å…³æ–‡ä»¶

- **æ¨¡å‹**: `case_management/models.py` - `DocumentTemplate`
- **åºåˆ—åŒ–å™¨**: `case_management/serializers.py` - `BatchSortSerializer`
- **è§†å›¾**: `case_management/views.py` - `DocumentTemplateViewSet.batch_sort`
- **è¿ç§»**: `case_management/migrations/0014_add_sort_and_print_fields.py`

## æ‰©å±•åŠŸèƒ½

### è‡ªåŠ¨é‡æ•´æ’åº

å¯ä»¥æ·»åŠ ä¸€ä¸ªç®¡ç†å‘½ä»¤æ¥è‡ªåŠ¨é‡æ•´æ‰€æœ‰æ¨¡æ¿çš„æ’åºï¼š

```python
# management/commands/reorder_templates.py
from django.core.management.base import BaseCommand
from case_management.models import DocumentTemplate

class Command(BaseCommand):
    help = 'é‡æ•´æ¨¡æ¿æ’åº'

    def handle(self, *args, **options):
        templates = DocumentTemplate.objects.filter(is_deleted=False).order_by('sort_order', 'id')
        
        for index, template in enumerate(templates):
            template.sort_order = (index + 1) * 1000
        
        DocumentTemplate.objects.bulk_update(templates, ['sort_order'])
        
        self.stdout.write(self.style.SUCCESS(f'æˆåŠŸé‡æ•´ {len(templates)} ä¸ªæ¨¡æ¿çš„æ’åº'))
```

ä½¿ç”¨ï¼š
```bash
python manage.py reorder_templates
```

## æ€»ç»“

âœ… å·²å®ç°çš„åŠŸèƒ½ï¼š
- [x] æ•°æ®åº“å­—æ®µ `sort_order`ï¼ˆå¸¦ç´¢å¼•ï¼‰
- [x] æ‰¹é‡æ’åº API æ¥å£
- [x] æ•°æ®éªŒè¯ï¼ˆåºåˆ—åŒ–å™¨ï¼‰
- [x] äº‹åŠ¡ä¿æŠ¤
- [x] æ‰¹é‡æ›´æ–°ä¼˜åŒ–
- [x] é”™è¯¯å¤„ç†
- [x] æ—¥å¿—è®°å½•
- [x] API æ–‡æ¡£

ğŸ¯ é€‚ç”¨åœºæ™¯ï¼š
- æ–‡æ¡£æ¨¡æ¿çš„æ‹–æ‹½æ’åº
- å‰ç«¯ä½¿ç”¨é—´éš”ç¼–å·æ³•ä¼˜åŒ–æ€§èƒ½
- æ”¯æŒå•ä¸ªæˆ–æ‰¹é‡æ›´æ–°æ’åº

ğŸ“ˆ æ€§èƒ½ç‰¹ç‚¹ï¼š
- ä½¿ç”¨æ•°æ®åº“ç´¢å¼•åŠ é€ŸæŸ¥è¯¢
- æ‰¹é‡æ›´æ–°å‡å°‘æ•°æ®åº“æ“ä½œ
- äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
- é—´éš”ç¼–å·æ³•å‡å°‘æ›´æ–°æ¬¡æ•°

